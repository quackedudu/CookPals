<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CookPals - Recipe Suggester</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff8e1; /* Soft cream/pale yellow color */
            min-height: 100vh; 
            position: relative;
            overflow-x: hidden;

            /* Main Background Pattern */
            background-image: radial-gradient(circle at 1px 1px, #f0e0d6 1px, transparent 0);
            background-size: 20px 20px;
            background-repeat: repeat;
        }

        .character-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .character {
            position: absolute;
            background-repeat: no-repeat;
            background-size: contain;
            opacity: 0.15;
        }

        .avocado-chef {
            width: 150px;
            height: 150px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="avocadoGradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%239CCC65"/><stop offset="100%" style="stop-color:%23689F38"/></linearGradient><linearGradient id="hatGradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%23FFEB3B"/><stop offset="100%" style="stop-color:%23FBC02D"/></linearGradient></defs><circle cx="50" cy="50" r="45" fill="url(%23avocadoGradient)"/><circle cx="50" cy="50" r="15" fill="%23A1887F"/><path d="M50 0 L70 30 A20 20 0 0 1 50 30 L30 30 Z" fill="url(%23hatGradient)"/><path d="M40 35 C35 30 65 30 60 35 L60 40 C65 45 35 45 40 40 Z" fill="%23FFF"/><circle cx="40" cy="55" r="5" fill="%23212121"/><circle cx="60" cy="55" r="5" fill="%23212121"/><path d="M40 70 Q50 75 60 70" stroke="%23212121" stroke-width="2" fill="none"/></svg>');
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.2;
            z-index: 1;
        }

        .carrot-char {
            width: 80px; height: 80px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M30 20 C20 0 80 0 70 20 L60 80 C55 90 45 90 40 80 Z" fill="%23FF9800"/><path d="M60 80 C55 90 45 90 40 80 L40 70 L60 70 Z" fill="%23F57C00"/><path d="M50 15 C45 5 55 5 50 15 L50 25 Z" fill="%234CAF50"/><circle cx="40" cy="40" r="3" fill="%23212121"/><circle cx="60" cy="40" r="3" fill="%23212121"/><path d="M45 55 Q50 60 55 55" stroke="%23212121" stroke-width="2" fill="none"/></svg>');
            top: 15%; right: 5%;
        }

        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 10;
        }

        .btn-3d {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s;
        }
        .btn-3d:active {
            transform: translate(0, 2px);
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        }
        .btn-indigo-3d { box-shadow: 0 4px 0 #3730a3; }
        .btn-blue-3d { box-shadow: 0 4px 0 #1e40af; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="character-container">
        <div class="character avocado-chef"></div>
        <div class="character carrot-char hidden md:block"></div>
    </div>

    <div class="w-full bg-white card rounded-xl p-6 md:p-10 max-w-5xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">
            CookPals ü•ë
        </h1>
        <p class="text-gray-500 mb-6 text-center">
            Upload photos of your ingredients and we'll craft a perfect recipe!
        </p>

        <div class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                <div class="w-full">
                    <div id="imagePreviews" class="mb-6 md:mb-0 p-4 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 flex flex-wrap gap-3 justify-center items-center min-h-[200px] transition-all duration-300">
                        <span id="previewPlaceholder" class="text-gray-400 text-center">No ingredients added yet.</span>
                    </div>
                    <div id="cameraWrapper" class="relative mb-6 mx-auto hidden max-w-sm aspect-square rounded-xl overflow-hidden shadow-lg">
                        <video id="cameraFeed" class="w-full h-full object-cover" autoplay playsinline></video>
                    </div>
                    <canvas id="photoCanvas" class="hidden"></canvas>
                </div>

                <div class="flex flex-col w-full space-y-4 pt-0 md:pt-4">
                    <input type="file" id="imageUpload" accept="image/*" multiple class="hidden" onchange="handleFileInput(event)">
                    <button onclick="document.getElementById('imageUpload').click()"
                            class="w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 btn-3d btn-indigo-3d flex items-center justify-center">
                        <span class="text-xl mr-2">üìÅ</span>Add Photos
                    </button>
                    <button id="cameraButton" onclick="toggleCamera()"
                            class="w-full px-4 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-150 btn-3d btn-blue-3d flex items-center justify-center">
                        <span class="text-xl mr-2">üì∑</span>Use Camera
                    </button>
                    <button id="captureButton" onclick="capturePhoto()"
                            class="hidden w-full px-4 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 flex items-center justify-center">
                        <span class="text-xl mr-2">üì∏</span>Capture & Add
                    </button>
                    <button id="clearImagesButton" onclick="resetImageState()"
                            class="w-full px-4 py-3 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition duration-150">
                        <span class="text-xl mr-2">üóëÔ∏è</span>Clear All
                    </button>
                </div>
            </div>
        </div>
        
        <button id="generateButton" onclick="generateRecipes()" disabled
                class="w-full px-6 py-4 bg-green-500 text-white font-bold rounded-lg transition duration-150 opacity-50 cursor-not-allowed hover:bg-green-600 mt-6">
            Generate Recipe (0 Ingredients)
        </button>

        <div id="loadingIndicator" class="mt-8 hidden text-center">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-5 h-5 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                <span class="text-indigo-600 font-medium">Analyzing ingredients...</span>
            </div>
        </div>

        <div id="results" class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 hidden" id="resultsTitle">Your Recipe</h2>
            <div id="recipeOutput" class="space-y-6"></div>
            <div id="errorMessage" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg border border-red-200"></div>
        </div>
    </div>

    <script>
        const apiKey = "ADD API HERE"; 
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const MAX_RETRIES = 5;

        let uploadedImages = []; 
        let mediaStream = null;

        const cameraFeed = document.getElementById('cameraFeed');
        const photoCanvas = document.getElementById('photoCanvas');
        const imagePreviews = document.getElementById('imagePreviews');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const cameraWrapper = document.getElementById('cameraWrapper');
        const generateButton = document.getElementById('generateButton');
        const cameraButton = document.getElementById('cameraButton');
        const captureButton = document.getElementById('captureButton');

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function updateGenerateButtonState() {
            const count = uploadedImages.length;
            generateButton.textContent = `Generate Recipe (${count} Ingredient${count !== 1 ? 's' : ''})`;
            generateButton.disabled = count === 0;
            if (count === 0) {
                generateButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                generateButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function renderPreviews() {
            imagePreviews.innerHTML = '';
            if (uploadedImages.length === 0) {
                previewPlaceholder.classList.remove('hidden');
                imagePreviews.appendChild(previewPlaceholder);
            } else {
                previewPlaceholder.classList.add('hidden');
                uploadedImages.forEach(img => {
                    const previewEl = document.createElement('div');
                    previewEl.className = 'relative w-24 h-24 rounded-lg overflow-hidden border-2 border-gray-300 shadow-md';
                    previewEl.innerHTML = `
                        <img src="data:${img.mimeType};base64,${img.base64}" class="w-full h-full object-cover">
                        <button onclick="removeImage('${img.id}')" class="absolute top-0 right-0 p-1 bg-red-600 text-white text-xs rounded-bl-lg font-bold">
                            &times;
                        </button>
                    `;
                    imagePreviews.appendChild(previewEl);
                });
            }
            updateGenerateButtonState();
        }

        function addAndDisplayImage(type, b64Data) {
            uploadedImages.push({ id: crypto.randomUUID(), base64: b64Data, mimeType: type });
            renderPreviews();
        }

        function removeImage(id) {
            uploadedImages = uploadedImages.filter(img => img.id !== id);
            renderPreviews();
        }

        async function handleFileInput(event) {
            const files = event.target.files;
            if (files.length > 0) {
                for (const file of files) {
                    const b64Data = await fileToBase64(file);
                    addAndDisplayImage(file.type, b64Data);
                }
                event.target.value = ''; 
            }
        }

        async function toggleCamera() {
            if (mediaStream) {
                stopCamera();
            } else {
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    cameraFeed.srcObject = mediaStream;
                    cameraWrapper.classList.remove('hidden');
                    imagePreviews.classList.add('hidden');
                    captureButton.classList.remove('hidden');
                    cameraButton.innerHTML = 'Stop Camera';
                } catch (err) { showError("Camera access denied."); }
            }
        }

        function stopCamera() {
            if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); mediaStream = null; }
            cameraWrapper.classList.add('hidden');
            imagePreviews.classList.remove('hidden');
            captureButton.classList.add('hidden');
            cameraButton.innerHTML = 'Use Camera';
        }

        function capturePhoto() {
            photoCanvas.width = cameraFeed.videoWidth;
            photoCanvas.height = cameraFeed.videoHeight;
            const ctx = photoCanvas.getContext('2d');
            ctx.drawImage(cameraFeed, 0, 0);
            const dataURL = photoCanvas.toDataURL('image/jpeg', 0.8);
            addAndDisplayImage('image/jpeg', dataURL.split(',')[1]);
            stopCamera();
        }

        function resetImageState() {
            stopCamera();
            uploadedImages = [];
            renderPreviews();
            clearResults();
        }

        function clearResults() {
            document.getElementById('recipeOutput').innerHTML = '';
            document.getElementById('resultsTitle').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        const recipeSchema = {
            type: "OBJECT",
            properties: {
                "item_scanned": { "type": "STRING" },
                "recipe_title": { "type": "STRING" },
                "ingredients_table": {
                    "type": "ARRAY",
                    "items": {
                        "type": "OBJECT",
                        "properties": {
                            "ingredient": { "type": "STRING" },
                            "quantity": { "type": "STRING" }
                        },
                        "required": ["ingredient", "quantity"]
                    }
                },
                "procedure": {
                    "type": "ARRAY",
                    "items": { "type": "STRING" }
                }
            },
            required: ["item_scanned", "recipe_title", "ingredients_table", "procedure"]
        };

        async function generateRecipes() {
            clearResults();
            document.getElementById('loadingIndicator').classList.remove('hidden');
            generateButton.disabled = true;

            const prompt = `Identify ingredients in the photos. Create a healthy recipe using them.
            CRITICAL INSTRUCTION: For the 'ingredients_table', use plain text words for ingredients and standard measurements (e.g., '200g', '1 tablespoon', '2 pieces'). 
            DO NOT use symbols, emojis, or coded abbreviations in the table.`;

            const contentsParts = [{ text: prompt }, ...uploadedImages.map(img => ({ inlineData: { mimeType: img.mimeType, data: img.base64 } }))];

            await callApiWithRetry({
                contents: [{ parts: contentsParts }],
                generationConfig: { responseMimeType: "application/json", responseSchema: recipeSchema }
            });

            document.getElementById('loadingIndicator').classList.add('hidden');
            updateGenerateButtonState();
        }

        async function callApiWithRetry(payload) {
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(`${API_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const result = await response.json();
                    const recipeData = JSON.parse(result.candidates[0].content.parts[0].text);
                    displayRecipes(recipeData);
                    return;
                } catch (error) {
                    if (i === MAX_RETRIES - 1) showError(error.message);
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        function displayRecipes(data) {
            document.getElementById('resultsTitle').classList.remove('hidden');
            document.getElementById('recipeOutput').innerHTML = `
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <p class="text-sm text-indigo-600 font-bold mb-1">IDENTIFIED INGREDIENTS</p>
                    <p class="text-gray-700 mb-6">${data.item_scanned}</p>
                    
                    <h3 class="text-2xl font-bold text-gray-900 mb-4">${data.recipe_title}</h3>
                    
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-800 mb-2">Ingredients Needed:</h4>
                        <div class="overflow-hidden border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Ingredient</th>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Amount</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${data.ingredients_table.map(item => `
                                        <tr>
                                            <td class="px-4 py-3 text-sm text-gray-900 font-medium">${item.ingredient}</td>
                                            <td class="px-4 py-3 text-sm text-gray-600">${item.quantity}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-gray-800 mb-2">Instructions:</h4>
                        <ol class="space-y-3">
                            ${data.procedure.map((step, i) => `
                                <li class="flex gap-3 text-gray-700">
                                    <span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs">${i+1}</span>
                                    <span>${step}</span>
                                </li>
                            `).join('')}
                        </ol>
                    </div>
                </div>
            `;
        }

        function showError(msg) {
            const err = document.getElementById('errorMessage');
            err.textContent = msg;
            err.classList.remove('hidden');
        }

        window.onload = renderPreviews;
    </script>
</body>

</html>
